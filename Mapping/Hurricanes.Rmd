---
title: "Visualizing Hurricane Trajectories"
output: html_document
---



#Description

Inspired by Aaron Koblin's flight patterns and by Mapped British Shipping, I decided to play with a different data about storms (i.e. hurricanes) and try to map their trajectories. 

#The Data

The data is freely available from the International Best Track Archive for Climate Stewardship (IBTrACS)[http://www.ncdc.noaa.gov/ibtracs/index.php?name=wmo-data] at the National Climatic Data Center website and can be downloaded in different formats. In my case I decided to use the csv files although you can find a lot of different formats (pick the one that best fits your needs or preferences).
```{r}
# load packages

library(maps)
library(ggplot2)

# NOAA url
noaa = "ftp://eclipse.ncdc.noaa.gov/pub/ibtracs/v03r10/wmo/csv/basin/" 
#update v03r10 if needed - check https://www.ncdc.noaa.gov/ibtracs/index.php?name=wmo-data

# basins
basin = c("NA", "EP")

# read files from IBTrACS
NA.basin = read.csv(paste(noaa, "Basin.", basin[1], ".ibtracs_wmo.v03r10.csv", sep = ""), skip = 1, stringsAsFactors = FALSE)
EP.basin = read.csv(paste(noaa, "Basin.", basin[2], ".ibtracs_wmo.v03r10.csv", sep = ""), skip = 1, stringsAsFactors = FALSE)
#update v03r10 if needed - check https://www.ncdc.noaa.gov/ibtracs/index.php?name=wmo-data

# remove variable information
NA.basin = NA.basin[-1, ]
EP.basin = EP.basin[-1, ]

# formatting some columns
NA.basin$Season = as.numeric(NA.basin$Season)
NA.basin$Latitude = as.numeric(gsub("^ ", "", NA.basin$Latitude))
NA.basin$Longitude = as.numeric(gsub("^ ", "", NA.basin$Longitude))
NA.basin$Wind.WMO. = as.numeric(gsub("^ ", "", NA.basin$Wind.WMO.))

EP.basin$Season = as.numeric(EP.basin$Season)
EP.basin$Latitude = as.numeric(gsub("^ ", "", EP.basin$Latitude))
EP.basin$Longitude = as.numeric(gsub("^ ", "", EP.basin$Longitude))
EP.basin$Wind.WMO. = as.numeric(gsub("^ ", "", EP.basin$Wind.WMO.))

# extract month for dataset NA.basin
time.date = strsplit(NA.basin$ISO_time, " ")
iso.date = unlist(lapply(time.date, function(x) x[1]))
iso.month = substr(iso.date, 6, 7)
NA.basin$Month = factor(iso.month, labels = c(month.name))

# extract month for dataset EP.basin
time.date = strsplit(EP.basin$ISO_time, " ")
iso.date = unlist(lapply(time.date, function(x) x[1]))
iso.month = substr(iso.date, 6, 7)
EP.basin$Month = factor(iso.month, labels = c(month.name)[-4])

# join data frames
storms = rbind(NA.basin, EP.basin)
```

##Prepare the plot ingredients

Once we've cleaned and processed the data, the next step is to prepare the ingredients for plotting a map. For this example, I'm selecting hurricanes from 1999 to 2010, and removing unnamed storms:
```{r}
# world map
wm = map_data("world")

# select storms between 1999 and 2010
substorms = subset(storms, Season %in% 1999:2016)#update 2016 if needed
nop = which(substorms$Name == "UNNAMED")
substorms = substorms[-nop, ]

# add and ID with name and season
substorms$ID = as.factor(paste(substorms$Name, substorms$Season, sep = "."))

# storm name as factor
substorms$Name = as.factor(substorms$Name)
```

##Overall Hurricanes

Let's plot the data with all the selected storms
```{r map1, warning=FALSE}
map1 = ggplot(substorms, aes(x = Longitude, y = Latitude, group = ID)) +
    geom_polygon(data = map_data("world"), aes(x = long, y = lat, group = group), fill = "gray25", colour = "gray10", size = 0.2) + 
     geom_path(data = substorms, aes(group = ID, color = Wind.WMO.), alpha = 0.5, size = 0.8) + 
     xlim(-138, -20) + 
     ylim(3, 55) + 
     labs(x = "", y = "", color = "Wind \n(knots)") +
     theme(panel.background = element_rect(fill = "gray10", color = "gray30"), 
           title = element_text("Hurricane Trajectories 1999 - 2010"), axis.ticks = element_blank(), 
           panel.grid.minor=element_blank(), panel.grid.major = element_blank(), axis.text.x = element_blank(),
           axis.text.y = element_blank()
    )
# show me the map
map1
``` 

##Hurricanes by month

Let's get a more interesting visualization by months
```{r map2, warning=FALSE}
# with facet-wrap by Month
map2 = ggplot(substorms, aes(x = Longitude, y = Latitude, group = ID)) + 
     geom_polygon(data = map_data("world"), aes(x = long, y = lat, group = group), fill = "gray25", color = "gray10", size = 0.2) + 
     geom_path(data = substorms, aes(group = ID, color = Wind.WMO.), size = 0.5) + 
     xlim(-138, -20) + 
     ylim(3, 55) + 
     labs(x = "", y = "", color = "Wind \n(knots)") + facet_wrap(~Month) + 
     theme(title = element_text("Hurricane Trajectories by Month (1999 - 2016)"), panel.background = element_rect(fill = "gray10", 
        color = "gray30"), axis.text.x = element_blank(), axis.text.y = element_blank(), 
        axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()
        )
map2
```

## Hurricanes by Year

```{r map3, warning=FALSE}
# with facet-wrap by Month
map3 = ggplot(substorms, aes(x = Longitude, y = Latitude, group = ID)) + 
     geom_polygon(data = map_data("world"), aes(x = long, y = lat, group = group), fill = "gray25", color = "gray10", size = 0.2) + 
     geom_path(data = substorms, aes(group = ID, color = Wind.WMO.), size = 0.5) + 
     xlim(-138, -20) + 
     ylim(3, 55) + 
     labs(x = "", y = "", color = "Wind \n(knots)") + facet_wrap(~Season) + 
     theme(title = element_text("Hurricane Trajectories by Year"), panel.background = element_rect(fill = "gray10", 
        color = "gray30"), axis.text.x = element_blank(), axis.text.y = element_blank(), 
        axis.ticks = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()

        )
map3
```

```{r}
#https://stackoverflow.com/questions/32580946/setting-absolute-size-of-facets-in-ggplot2
set_panel_size <- function(p=NULL, g=ggplotGrob(p), file=NULL, 
                           margin = unit(1,"mm"),
                           width=unit(4, "cm"), 
                           height=unit(4, "cm")){

  panels <- grep("panel", g$layout$name)
  panel_index_w<- unique(g$layout$l[panels])
  panel_index_h<- unique(g$layout$t[panels])
  nw <- length(panel_index_w)
  nh <- length(panel_index_h)

if(getRversion() < "3.3.0"){

   # the following conversion is necessary
   # because there is no `[<-`.unit method
   # so promoting to unit.list allows standard list indexing
   g$widths <- grid:::unit.list(g$widths)
   g$heights <- grid:::unit.list(g$heights)

   g$widths[panel_index_w] <- rep(width, nw)
   g$heights[panel_index_h] <- rep(list(height), nh)

} else {

   g$widths[panel_index_w] <-  rep(width,  nw)
   g$heights[panel_index_h] <- rep(height, nh)

}

  if(!is.null(file))
    ggsave(file, g, 
           width = convertWidth(sum(g$widths) + margin, 
                                unitTo = "in", valueOnly = TRUE),
           height = convertHeight(sum(g$heights) + margin,  
                                  unitTo = "in", valueOnly = TRUE))

  g
}
```





Reference:  Orignal code found [here](From https://rpubs.com/gaston/hurricanes).  Updated so ggplot works.