---
title: "R Animation Examples"
output:
  prettydoc::html_pretty:
    theme: tactile
    highlight: github
---

# Introduction
There are several tools available in R for creating animations (movies) from statistical graphics. The animation package by Yihui Xie will create an animated GIF or video file, using a series of R charts you generate as the frames. And the gganimate package by David Robinson is an extension to ggplot2 that will create a movie from charts created using the ggplot2 syntax: in much the same way that you can create multiple panels using faceting, you can instead create an animation with multiple frames.

> NOTE: to use the gganimate package, install [ImageMagick](https://www.imagemagick.org/script/download.php). On Windows and select the "install legacy utilities" option during install.

# Load Libraries

```{r loadLibs1, warning=FALSE, message=FALSE}
#if(!require(breakDown)){devtools::install_github("dgrtwo/gganimate")}
if(!require(easypackages)){install.packages("easypackages")}
library(easypackages)
packages("dplyr", "gganimate", "gapminder", "tweenr", "ggplot2", "readr", prompt = FALSE)

options(scipen = 999)#Do not display exponents
```

# Example 1- Gapminder

```{r fig.show = "animate"}
# For example, suppose we wanted to create an animation similar to the Gapminder 
# world animation, using Jenny Bryan's gapminder package for the data.
gapminder <- gapminder

theme_set(theme_bw())
p <- ggplot(gapminder, aes(gdpPercap, lifeExp, size = pop, color = continent, frame = year)) +
  geom_point() + scale_x_log10()

# Notice we added frame = year and saved the plot as p. 
# We then display it as an animation with the gg_animate function:
gganimate(p)
```

The tweenr package doesn't actually perform any animation itself; rather, it calculates smooth interpolations between data points to create new rows in the data which can be used as frames in the animation created by the gganimate package. Here's the same chart, with data processed by tweenr: 

```{r fig.show = "animate"}
gapminder_edit <- gapminder %>% arrange(country, year) %>%
  select(gdpPercap,lifeExp,year,country, continent, pop) %>%
  rename(x=gdpPercap,y=lifeExp,time=year,id=country) %>%
  mutate(ease="linear")

gapminder_tween <- tween_elements(gapminder_edit, "time", "id", "ease", nframes = 300) %>%
  mutate(year = round(time), country = .group) %>%
  left_join(gapminder, by=c("country","year","continent")) %>%
  rename(population = pop.x)

p2 <- ggplot(gapminder_tween,  aes(x=x, y=y, frame = .frame)) +
  geom_point(aes(size=population, color=continent),alpha=0.8) +
  xlab("GDP per capita") + ylab("Life expectancy at birth") + scale_x_log10()

gganimate(p2, filename="gapminder-tween.gif", title_frame = FALSE, interval = 0.05)
```
```{r}
setwd("~/GitHub/Visualizations")
gganimate(p, "animateExample1.html")
```

# Example 2 - Statistics - Not working

See https://github.com/dgrtwo/gganimate 

```{r}
p5 <- ggplot(gapminder2, aes(gdpPercap, lifeExp, size = pop, frame = year)) + geom_point() + 
     geom_smooth(aes(group = year), method = "lm", show.legend = FALSE) + facet_wrap(~ continent, scales = "free") 
     facet_wrap(~continent, scales = "free") + scale_x_log10()

gganimate(p5)
```

# Example 3

See http://paldhous.github.io/ucb/2016/dataviz/week14.html

- nations.csv Data from the World Bank Indicators portal, as used in week 3 and subsequently.
- warming.csv NASA data on the annual average global temperature, from 1880 to 2015, compared the the average from 1951-1980.
- maps Folder containing individual frames, from 1880 to 2015, each showing annual average temperatures across the globe, from 1880 to 2015, again compared the the average from 1951-1980. These were made from NASA data, using this software.
- charts combined Empty folders into which we will save individual frames from which to make a video animation.

```{r message=FALSE, warning=FALSE}
# load data
nations <- read_csv("./data/nations.csv")
# filter for 2014 data only
nations2014 <- nations %>%  filter(year == 2014)

# make bubble chart
ggplot(nations2014, aes(x = gdp_percap, y = life_expect)) +
  xlab("GDP per capita") +  ylab("Life expectancy at birth") +
  theme_minimal(base_size = 12) +
  geom_point(aes(size = population, color = region), alpha = 0.7) +
  scale_size_area(guide = FALSE, max_size = 15) +
  scale_x_continuous(labels = scales::dollar) +
  stat_smooth(formula = y ~ log10(x), se = FALSE, size = 0.5, color = "black", linetype="dotted") +
  scale_color_brewer(name = "", palette = "Set2") +
  theme(legend.position=c(0.8,0.4))
```

- `scale_size_area` ensures that the size of the circles scales by their area according to the population data, up to the specified max_size; guide = FALSE within the brackets of this function prevents a legend for size being drawn.
- `labels = scales::dollar` formats the X axis labels as currency in dollars.
- `stat_smooth` works like `geom_smooth` but allows you to use a formula to specify the type of curve to use for to trend line fitted to the data, here a logarithmic curve.

Use `gganimate` to generate an animation of the chart, from 1990 to 2014.

```{r}
nations_chart <- ggplot(nations, aes(x = gdp_percap, y = life_expect, frame = year)) +
  xlab("GDP per capita") +
  ylab("Life expectancy at birth") +
  theme_minimal(base_size = 16) +
  geom_point(aes(size = population, color = region), alpha = 0.7) +
  scale_size_area(guide = FALSE, max_size = 20) +
  scale_x_continuous(labels = scales::dollar) +
  stat_smooth(aes(group = year), formula = y ~ log10(x), se = FALSE, size = 0.5, color = "black", linetype="dotted") +
  scale_color_brewer(name = "", palette = "Set2") +
  theme(legend.position=c(0.8,0.4))
```

Running this code will create an R object of type `gg` called `nations_chart`.

Now display it in the Viewer panel by running the following:

```{r}
gganimate(nations_chart)
```

## How the code works

I made a couple of small changes to the ggplot2 code from the static graphic to optimize the appearance of the animation, increasing both the base_size for the text, and the max_size for the scaled circles.

The most important change, however, is in the initial ggplot() function, which now includes frame = year. In the animation, this is the code that creates a separate chart for each year in the data.

Also notice that the code that creates the trend line now includes aes(group = year). This is needed if we want to create a separate trend line for each year. Without this, a single trend line would be calculated for all the data across all the years, and would be static across the animation.

Save as a GIF and a video
Having made an animation, we can now save it as a GIF or a video:

## Save as a GIF
```{r}
gg_animate(nations_chart, "nations.gif", ani.width = 750, ani.height = 500, interval = 0.2)
```

## Save as a video 

```{r}
gg_animate(nations_chart, "nations.mp4", ani.width = 1600, ani.height = 900, interval = 0.1)
```

You can use the options `ani.width` and `ani.height` to set the dimensions, in pixels, of the animation; `interval` sets the interval between the frames, in seconds (the default is 1 second). For the video, the ratio between width and height at 16:9 is set, consistent with YouTube and Vimeo format.

## Use tweenr

To interpolate data using tweenrâ€™s `tween_elements()` function, first create a data frame with the fields `x` for the co-ordinate on the X axis, `y` for the co-ordinate on the y axis, time for the data that will be used to make the frames, and id for the unique identifier for each point. Also need a variable called `ease` which defines the method to use for the interpolation: "linear" will achieve a smooth, steady animation.

```{r}
# prepare data
nations_edit <- nations %>%
  arrange(country, year) %>% select(gdp_percap,life_expect,year,country) %>%
  rename(x=gdp_percap,y=life_expect,time=year,id=country) %>% mutate(ease="linear")

# tween
nations_tween <- tween_elements(nations_edit, "time", "id", "ease", nframes = 300)
```

`tween_elements()` creates new variables called `.frame`, one for each of the specified number of frames, and `.group`, which corresponds to the id in the previous data frame, here the country names. It calculates new `x`, `y`, and `time` values for each frame. 

To make the animated chart, join to the original data, which means creating `year` and `country` variables to match against the original data.

```{r}
# create year and country fields, for join
nations_tween <- nations_tween %>% mutate(year = round(time), country = .group)

# join
nations_tween <- inner_join(nations_tween,nations)
```

Now we can make the animated chart using gganimate:

```{r}
# make animated chart
nations_tween_chart <- ggplot(nations_tween, aes(x = x, y = y, frame = .frame)) +
  xlab("GDP per capita") +
  ylab("Life expectancy at birth") +
  theme_minimal(base_size = 16, base_family = "Georgia") +
  geom_point(aes(size = population, color = region), alpha = 0.7) +
  scale_size_area(guide = FALSE, max_size = 20) +
  scale_x_continuous(labels = scales::dollar) +
  scale_color_brewer(name = "", palette = "Set2") +
  theme(legend.position=c(0.8,0.4))

# run in the viewer
gganimate(nations_tween_chart, title_frame = FALSE, interval = 0.05)
```

## Make a cumulative animation of historical global average temperature

```{r}
# load data
warming <- read_csv("./data/warming.csv")

# set color palette and sequence of values to apply it to
pal <- c("#313695","#4575b4","#74add1","#abd9e9","#e0f3f8","#ffffbf","#fee090","#fdae61","#f46d43","#d73027","#a50026")
vals <- seq(-2, 2, length = 11)

# draw chart
ggplot(warming, aes(x = year, y = annual)) +
  geom_line(colour="black") +
  geom_point(shape = 21, colour="black", aes(fill=annual), size=5, stroke=1) +
  scale_x_continuous(limits=c(1880,2015)) +
  scale_y_continuous(limits=c(-0.5,1)) +
  theme_minimal() +
  scale_fill_gradientn(colors = pal, values = vals, rescaler = function(x, ...) x, guide=FALSE) +
  xlab("") + ylab("Difference from 1951-1980 (ÂºC)") + theme(text=element_text(size=12))
```

```{r}
# create the animation
warming_chart <- ggplot(warming, aes(x = year, y = annual, frame = year, cumulative = TRUE)) +
  geom_line(colour="black") +
  geom_point(shape = 21, colour="black", aes(fill=annual), size=5, stroke=1) +
  scale_x_continuous(limits=c(1880,2015)) +
  scale_y_continuous(limits=c(-0.5,1)) +
  theme_minimal() +
  scale_fill_gradientn(colors = pal, values = vals, rescaler = function(x, ...) x, guide=FALSE) +
  xlab("") +
  ylab("Difference from 1951-1980 (ÂºC)") +
  theme(text=element_text(size=16, family="Georgia"))

# run in the viewer
gganimate(warming_chart, interval = 0.1)
```

